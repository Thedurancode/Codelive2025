import{r as s,b2 as D,j as $,b3 as K,a as Q,b4 as X,b5 as Y,b6 as Z,b7 as tt,b8 as et,b9 as st,ba as rt,bb as nt,bc as at,bd as ot,be as ct}from"./index-CzQ-6GRY.js";function S(t){var e;return(e=t.children)==null||e.sort((r,o)=>(r.type==="directory"&&S(r),o.type==="directory"&&S(o),r.type==="directory"&&o.type==="file"?-1:r.type==="file"&&o.type==="directory"?1:r.basename.localeCompare(o.basename))),t}function ut(t,e){return S(I(t,e))}function I(t,e){return t.path===e.path?e.children===null?{...e,children:t.children}:{...e,children:j(t.children,e.children)}:t.children?{...t,children:t.children.map(r=>r.type==="directory"?I(r,e):r)}:t}function j(t,e){return t?e.map(r=>{const o=t.find(n=>n.path===r.path);return o&&o.type==="directory"&&r.type==="directory"?{...r,children:r.children===null?o.children:j(o.children,r.children)}:r}):e}function it(t,e,r){return S(A(t,e,r))}function A(t,e,r){const o=t.children===null?null:t.children.map(n=>n.type==="directory"?A(n,e,r):n.path.startsWith(e.path)?{...n,path:n.path.replace(e.path,r.path)}:n);if(t.path===e.path)return{...r,children:o};if(t.path.startsWith(e.path)){const n=t.path.replace(e.path,r.path);return{...t,path:n,children:o}}else return{...t,children:o}}function lt(t,e,r){return S(F(t,e,r))}function F(t,e,r){if(t.children===null)return t;const o=[];for(const n of t.children)n.path===e.path?o.push(r):n.type==="directory"?o.push(F(n,e,r)):o.push(n);return{...t,children:o}}function V(t,e){if(t.children===null)return t;const r=[];for(const o of t.children)o.path!==e&&(o.type==="directory"?r.push(V(o,e)):r.push(o));return{...t,children:r}}function R(t,e){return S(J(t,e))}function J(t,e){if(t.children===null)return t;if(t.path===e.dirname){const o=t.children.findIndex(c=>c.path===e.path),n=[...t.children];return o===-1?n.push(e):n.splice(o,1,e),{...t,children:n}}const r=t.children.map(o=>o.type==="directory"?J(o,e):o);return{...t,children:r}}const M=s.createContext(void 0);function ht({app:t,children:e}){const[r,o]=s.useState(t),n=s.useRef(D.create(r.id));s.useEffect(()=>(n.current.appId!==r.id&&(n.current.unsubscribe(),n.current=D.create(r.id)),n.current.subscribe(),()=>n.current.unsubscribe()),[r.id]);async function c(v){const{data:u}=await K(r.id,v);o(u)}return $.jsx(M.Provider,{value:{app:r,updateApp:c,channel:n.current},children:e})}function U(){return s.useContext(M)}function bt(t){const e=window.localStorage.getItem(`apps:${t}:last_opened_file`);return typeof e=="string"?JSON.parse(e):null}function ft(t,e){return window.localStorage.setItem(`apps:${t}:last_opened_file`,JSON.stringify(e))}const T=s.createContext(void 0);function gt({channel:t,rootDirEntries:e,initialOpenedFile:r,children:o}){const[,n]=s.useReducer(a=>a+1,0),{app:c}=U(),v=Q(),u=s.useRef(S(e)),f=s.useRef(new Set),[h,C]=s.useState(r),l=s.useCallback(a=>{C(p=>{const d=a(p);return d&&ft(c.id,d),d})},[c.id]);s.useEffect(()=>{function a(p){l(()=>p.file),n()}return t.on("file:updated",a),()=>{t.off("file:updated",a)}},[t,l]);const k=s.useCallback(a=>{v(`/apps/${c.id}/files/${encodeURIComponent(a.path)}`)},[c.id,v]);s.useEffect(()=>{r!==null&&(r==null?void 0:r.path)!==(h==null?void 0:h.path)&&l(()=>r)},[r,h==null?void 0:h.path,l]);const E=s.useCallback(a=>{k(a)},[k]),i=s.useCallback(async(a,p,d)=>{d=d||"";const{data:g}=await X(c.id,a,p,d);return u.current=R(u.current,g),n(),g},[c.id]),b=s.useCallback(a=>{t.push("file:updated",{file:a}),l(()=>a),n()},[t,l]),m=s.useCallback(async a=>{await Y(c.id,a.path),l(p=>p&&p.path===a.path?null:p),u.current=V(u.current,a.path),n()},[c.id,l]),x=s.useCallback(async(a,p)=>{const{data:d}=await Z(c.id,a.path,p);l(g=>g&&g.path===a.path?{...g,path:d.path,name:d.basename}:g),u.current=lt(u.current,a,d),n()},[c.id,l]),y=s.useCallback(a=>f.current.has(a.path),[]),P=s.useCallback(async a=>{f.current.add(a.path),n();const{data:p}=await tt(c.id,a.path);u.current=ut(u.current,p),n()},[c.id]),w=s.useCallback(a=>{f.current.delete(a.path),n()},[]),L=s.useCallback(a=>{y(a)?w(a):P(a)},[y,P,w]),z=s.useCallback(async(a,p)=>{const{data:d}=await et(c.id,a,p);u.current=R(u.current,d),n(),P(d)},[c.id,P]),B=s.useCallback(async a=>{await st(c.id,a.path),l(p=>p&&p.path.startsWith(a.path)?null:p),f.current.delete(a.path),u.current=V(u.current,a.path),n()},[c.id,l]),G=s.useCallback(async(a,p)=>{const{data:d}=await rt(c.id,a.path,p);l(g=>g&&g.path.startsWith(a.path)?{...g,path:g.path.replace(a.path,d.path)}:g),f.current.has(a.path)&&(f.current.delete(a.path),f.current.add(d.path)),u.current=it(u.current,a,d),n()},[c.id,l]),H={fileTree:u.current,openedFile:h,openFile:E,createFile:i,updateFile:b,renameFile:x,deleteFile:m,createFolder:z,renameFolder:G,deleteFolder:B,openFolder:P,closeFolder:w,toggleFolder:L,isFolderOpen:y};return $.jsx(T.Provider,{value:H,children:o})}function vt(){return s.useContext(T)}const _=s.createContext(void 0);function Ct({channel:t,children:e}){const[r,o]=s.useState([]),[n,c]=s.useState(0),[v,u]=s.useState("default"),[f,h]=s.useState(!1);function C(){o([]),u("default"),c(0)}const l=s.useCallback((i,b,m)=>{o(x=>[...x,{type:i,message:m,source:b,timestamp:new Date}]),i==="stderr"&&u("error"),c(x=>x+1)},[]);function k(){h(i=>!i),u("default"),c(0)}function E(){h(!1),u("default"),c(0)}return s.useEffect(()=>{function i(m){for(const x of m.log.data.split(`
`))l(m.log.type,"vite",x)}t.on("preview:log",i);function b(m){for(const x of m.log.data.split(`
`))l(m.log.type,"npm",x)}return t.on("deps:install:log",b),()=>{t.off("preview:log",i),t.off("deps:install:log",b)}},[t,l]),$.jsx(_.Provider,{value:{logs:r,clearLogs:C,unreadLogsCount:n,panelIcon:v,addLog:l,open:f,togglePane:k,closePane:E},children:e})}function N(){return s.useContext(_)}const W=s.createContext(void 0);function mt({channel:t,children:e}){const[r,o]=s.useState("idle"),[n,c]=s.useState([]),[v,u]=s.useState(null),[f,h]=s.useState(!1),{addLog:C}=N();s.useEffect(()=>{t.push("deps:status",{})},[t]),s.useEffect(()=>{const i=b=>{u(b.nodeModulesExists)};return t.on("deps:status:response",i),()=>{t.off("deps:status:response",i)}},[t]),s.useEffect(()=>{const i=b=>{o(b.status)};return t.on("deps:install:status",i),()=>{t.off("deps:install:status",i)}},[t]);const l=s.useCallback(async i=>{C("info","srcbook",`Running ${i?`npm install ${i.join(" ")}`:"npm install"}...`);let b="";return new Promise((m,x)=>{const y=({log:w})=>{c(L=>[...L,w]),b+=w.data};t.on("deps:install:log",y);const P=w=>{switch(w.status){case"installing":break;case"failed":case"complete":t.off("deps:install:log",y),t.off("deps:install:status",P),C("info","srcbook",`${i?`npm install ${i.join(" ")}`:"npm install"} exited with status code ${w.code}`),w.status==="complete"?m():x(new Error(`Error running npm install: ${b}`));break}};t.on("deps:install:status",P),c([]),o("installing"),t.push("deps:install",{packages:i})})},[t,C]),k=s.useCallback(()=>{t.push("deps:clear",{}),c([])},[t]),E={npmInstall:l,clearNodeModules:k,nodeModulesExists:v,status:r,installing:r==="installing",failed:r==="failed",output:n,showInstallModal:f,setShowInstallModal:h};return $.jsx(W.Provider,{value:E,children:e})}function pt(){const t=s.useContext(W);if(!t)throw new Error("usePackageJson must be used within a PackageJsonProvider");return t}const O=s.createContext(void 0);function xt({channel:t,children:e}){const[r,o]=s.useState(null),[n,c]=s.useState("connecting"),[v,u]=s.useState(null),{npmInstall:f,nodeModulesExists:h}=pt(),{addLog:C}=N();s.useEffect(()=>{function E(i){switch(o(i.url),c(i.status),i.status){case"booting":C("info","srcbook","Dev server is booting...");break;case"running":C("info","srcbook",`Dev server is running at ${i.url}`);break;case"stopped":C("info","srcbook",`Dev server exited with status ${i.code}`),u(i.code);break}}return t.on("preview:status",E),()=>t.off("preview:status",E)},[t,C]);async function l(){h===!1&&await f(),t.push("preview:start",{})}const k=s.useCallback(()=>{t.push("preview:stop",{})},[t]);return s.useEffect(()=>{h===!1&&k()},[h,k]),nt(()=>{l()}),$.jsx(O.Provider,{value:{url:r,status:n,stop:k,start:l,exitCode:v},children:e})}function kt(){return s.useContext(O)}const q=s.createContext(void 0),wt=({children:t})=>{const{app:e}=U(),[r,o]=s.useState(null),n=s.useCallback(async()=>{if(e)try{const u=await at(e.id);o({sha:u.sha})}catch(u){console.error("Error fetching current version:",u)}},[e]);s.useEffect(()=>{n()},[n]);const c=s.useCallback(async u=>{if(e)try{const f=await ot(e.id,u);return o({sha:f.sha,message:u}),f.sha}catch(f){console.error("Error committing files:",f)}},[e]),v=s.useCallback(async u=>{if(e)try{const{sha:f}=await ct(e.id,u);o({sha:f})}catch(f){console.error("Error checking out version:",f)}},[e]);return $.jsx(q.Provider,{value:{currentVersion:r,createVersion:c,checkout:v,fetchVersions:n},children:t})},Et=()=>{const t=s.useContext(q);if(t===void 0)throw new Error("useVersion must be used within a VersionProvider");return t};export{ht as A,gt as F,Ct as L,mt as P,wt as V,xt as a,kt as b,pt as c,N as d,vt as e,Et as f,bt as g,U as u};
